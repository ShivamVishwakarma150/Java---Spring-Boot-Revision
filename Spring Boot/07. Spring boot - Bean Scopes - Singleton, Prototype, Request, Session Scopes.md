# **Spring Boot Bean Scopes: A Complete Guide**

### **Prerequisite: Understanding the Bean Lifecycle**
To grasp scopes, you must first understand the Spring Bean Lifecycle. The core flow is:
1.  **Bean Instantiation:** The IoC container creates a new instance of the bean.
2.  **Dependency Injection:** The container injects all the bean's dependencies.
3.  **Post-Construct:** Methods annotated with `@PostConstruct` are called. The bean is now fully constructed and ready for use.

Scopes dictate *when* and *how often* this lifecycle occurs for a specific bean.

---

### **1. Singleton Scope (`singleton`)**

*   **Definition:** The **default** scope. Only **one single instance** of the bean is created per IoC container. In most applications (which run a single IoC container), this translates to **one instance per application**.
*   **Initialization:** **Eagerly** initialized. The bean is created and its dependencies are injected **at application startup**.
*   **Usage:** Ideal for stateless services, configuration beans, utilities, and data access layers where a single shared instance is efficient and safe.

#### **Example & How It Works**
```java
// No scope defined = default is singleton
@RestController
public class TestController1 {
    @Autowired
    private User user;

    @GetMapping("/fetchUser")
    public String getUser() {
        return "User fetched: " + user.hashCode();
    }
}

// Explicitly defining singleton (optional)
@Component
@Scope(value = ConfigurableBeanFactory.SCOPE_SINGLETON) // or just @Scope("singleton")
public class User {
    public User() {
        System.out.println("User Initialization");
    }

    @PostConstruct
    public void init() {
        System.out.println("User Object Created: " + this.hashCode());
    }
}
```
**Application Startup Logs:**
```
User Initialization
User Object Created: 1140202235
TestController1 Instance Initialization
TestController1 Object Created: 2092450685
// Injected User hashcode in TestController1 will also be: 1140202235
```
**Key Takeaway:** The same `User` object (hashCode `1140202235`) is injected into every bean that needs it.

---

### **2. Prototype Scope (`prototype`)**

*   **Definition:** A **new instance** of the bean is created **every time** it is requested from the container.
*   **Initialization:** **Lazily** initialized. The object is created only when it is explicitly needed (e.g., injected into another bean or fetched via `applicationContext.getBean()`).
*   **Usage:** Ideal for stateful beans where each usage needs a separate, independent instance (e.g., a shopping cart in a non-web context, a processing context for a single task).

#### **Example & How It Works**
```java
@RestController
@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE) // New controller instance per request
public class TestController1 {
    @Autowired
    private User user; // User is also prototype
    @Autowired
    private Student student; // Student is singleton

    @GetMapping("/fetchUser")
    public String getUser() {
        return "User: " + user.hashCode() + ", Student: " + student.hashCode();
    }
}

@Component
@Scope("prototype") // New user instance every time
public class User { ... }

@Component // Singleton (default)
public class Student {
    @Autowired
    private User user; // Injected once at startup
}
```
**Application Startup Logs (Only eager singletons are created):**
```
Student Instance Initialization
--> Student needs a User, so a User is created NOW (lazily):
User Initialization
User Object Created: 889292929
Student Object Created: 777733333 // Injected User: 889292929
// TestController1 and its User are NOT created yet.
```
**First API Call (`/fetchUser`):**
```
--> New TestController1 instance is created (prototype):
TestController1 Instance Initialization
--> It needs a User. A NEW User is created (prototype):
User Initialization
User Object Created: 665544332 // Different from the one in Student!
--> It needs a Student. The existing singleton instance is injected.
// Response: User: 665544332, Student: 777733333
```
**Second API Call:** A completely new `TestController1` and a new `User` will be created, but the same `Student` is reused.

---

### **3. Request Scope (`request`)**

*   **Definition:** A **single instance** of the bean is created for and tied to the lifecycle of a **single HTTP request**. All dependencies within the same request will receive the same instance.
*   **Initialization:** **Lazily** initialized upon the first use within an HTTP request.
*   **Usage:** Perfect for storing data that is specific to a single web request, such as request parameters, and data that should not be shared with other requests.

#### **The ProxyMode Solution**
A critical issue arises when a **singleton** bean (eagerly created at startup) depends on a **request-scoped** bean (which needs an HTTP request to be created). This causes a `BeanCreationException` at startup.

**Solution:** Use `@Scope(proxyMode = ScopedProxyMode.TARGET_CLASS)`. This tells Spring to create a proxy (a dummy subclass) of the request-scoped bean at startup. The proxy is injected into the singleton. When a method is called on the proxy during an actual HTTP request, it delegates the call to the real bean instance created for that request.

#### **Example**
```java
@RestController // Singleton
public class TestController1 {
    @Autowired
    private User user; // Request-scoped bean

    @GetMapping("/fetchUser")
    public String getUser() {
        return "User from request: " + user.hashCode();
    }
}

@Component
@Scope(value = WebApplicationContext.SCOPE_REQUEST, proxyMode = ScopedProxyMode.TARGET_CLASS)
public class User {
    public User() {
        System.out.println("User Initialization for Request");
    }
}
```
**Application Startup:** Succeeds. A proxy object for `User` is created and injected into `TestController1`.
**First API Call (`/fetchUser`):**
```
User Initialization for Request // Real object is created for this request
// Response: User from request: 12345
```
**Second API Call:** A new `User` object with a different hashCode is created for the new request.

---

### **4. Session Scope (`session`)**

*   **Definition:** A **single instance** of the bean is created for and tied to the lifecycle of a user's **HTTP session**. The same instance is reused across multiple HTTP requests from the same session.
*   **Initialization:** **Lazily** initialized upon the first use within a new HTTP session.
*   **Usage:** Ideal for storing user-specific state, such as a user's authentication details, shopping cart contents, or profile information.

#### **Example**
```java
@RestController
@Scope(value = WebApplicationContext.SCOPE_SESSION)
public class TestController1 {
    @Autowired
    private User user; // Singleton

    @GetMapping("/fetchUser")
    public String getUser() { ... }

    @GetMapping("/logout")
    public String logout(HttpSession session) {
        session.invalidate(); // Manually end the session
        return "Logged out";
    }
}
```
**Application Startup:** The singleton `User` is created eagerly. The session-scoped `TestController1` is not created yet.
**First API Call (`/fetchUser`):** A new session is created. A new `TestController1` instance is created for this session. The singleton `User` is injected into it.
**Second API Call (`/fetchUser`):** The same session is still active. The *existing* `TestController1` instance for that session is used. **No new object is created.**
**Call to `/logout`:** The session is destroyed.
**Next Call to `/fetchUser`):** A **new session** is started. A **brand new instance** of `TestController1` is created for this new session.

---

### **5. Application Scope (`application`)**

*   **Definition:** Very similar to `singleton` but operates at a broader level. It ensures **one instance per `ServletContext`**, not per `ApplicationContext` (IoC container). This is crucial if you have multiple IoC containers (a very rare, advanced scenario) and need a bean to be a true singleton across all of them.
*   **Usage:** Extremely niche. In 99.9% of standard Spring Boot applications, `singleton` and `application` scopes behave identically.

### **Summary Table**

| Scope | Description | Initialization | Typical Use Case |
| :--- | :--- | :--- | :--- |
| **`singleton`** | One instance per IoC container | **Eager** | Stateless services, utilities, configurations |
| **`prototype`** | New instance every time it's needed | **Lazy** | Stateful beans with short lifetimes |
| **`request`** | One instance per HTTP request | **Lazy** | Storing request-specific data |
| **`session`** | One instance per user session | **Lazy** | Storing user-specific data (e.g., auth, cart) |
| **`application`**| One instance per ServletContext | Eager | Rare, for advanced multi-container setups |
